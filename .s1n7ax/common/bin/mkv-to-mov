#!/bin/sh

set -euxo pipefail


if [[ $# -eq 0 ]] ; then
  # has no parameters
  echo 'Converting all the files in the current dir to mov'

  mov_files=$(fd -t f --no-ignore '.*\.mkv')

  if [ -n "$mov_files" ]; then
    mkdir -p "converted";
    
    echo "$mov_files" | 
    xargs -I {} basename {} .mkv | \
    xargs -I {} \
    sh -c 'ffmpeg -i "{}.mkv" -vcodec mjpeg -q:v 2 -acodec pcm_s16be -q:a 0 -f mov "converted/{}.mov"'
  fi

  exit 0
else
  echo 'Converting "$1" to mov'

  abs_path=$(realpath "$1")

  if [ ! -f "$abs_path" ]; then
    echo "File not found"
    exit 1;
  fi

  mkdir -p "converted"
  target="$(dirname "$abs_path")/converted/$(basename "$abs_path")"

  ffmpeg -i "$abs_path" -vcodec mjpeg -q:v 2 -acodec pcm_s16be -q:a 0 -f mov "$target_path"

  exit 0
fi

